# Caching

This demo shows how to cache the response from a call to an external API using Redis.  It fetches currency exchange rate information for a given day from [https://exchangeratesapi.io/](https://exchangeratesapi.io/) and caches it in Redis as a String value for 15 seconds.

This API needs a (free) access key that you can obtain by [signing up here](https://exchangeratesapi.io/pricing/).  Once you have this, store it in an environment variable called `ACCESS_KEY`:

```bash
$ export ACCESS_KEY=<your access key>
```

When the code is run, it will first look in Redis to see if there is a cached response, returning that if so. If there isn't, it will fetch the data from the origin API, store it in Redis, set the expiry time to 15 seconds and return the data. The time taken to execute the program is recorded, so that the speedup associated with a cache hit can easily be seen.

## Setup

You will need to have a [Java 8 or higher JDK](https://openjdk.java.net/) installed, as well as [Apache Maven](https://maven.apache.org/) to build the project.

You will also need to [install Redis](https://redis.io/download) and have it running locally on the default port 6379 with no password set.  If you have Docker, see the instructions in the main [README](../) - I've provided a Docker Compose file that will start a container with Redis for you.

You can then build the project as follows:

```bash
$ ./build.sh
```

If the build succeeds, you should find `rediscachedemo-1.0-jar-with-dependencies.jar` in the `target` directory:

```bash
$ ls target/*.jar
target/rediscachedemo-1.0-jar-with-dependencies.jar
```

## Output

The `run.sh` script executes the code. The first time it runs, you can expect a cache miss:

```bash
$ ./run.sh
Looking in cache for: rates:latest
Cache miss, fetching from origin...
Caching origin response for 15 seconds at rates:latest
{"success":true,"timestamp":1631298844,"base":"EUR","date":"2021-09-10","rates":{"AED":4.339227,"AFN":100.032052,"ALL":121.609331,"AMD":582.252339,"ANG":2.120464,"AOA":738.703229,"ARS":115.89453,"AUD":1.604516,"AWG":2.127107,"AZN":2.013066,"BAM":1.952768,"BBD":2.385172,"BDT":100.471503,"BGN":1.952977,"BHD":0.445322,"BIF":2345.722192,"BMD":1.181398,"BND":1.58196,"BOB":8.145253,"BRL":6.202461,"BSD":1.181353,"BTC":2.5840863e-5,"BTN":86.736017,"BWP":12.882547,"BYN":2.96605,"BYR":23155.395148,"BZD":2.380967,"CAD":1.495591,"CDF":2359.251658,"CHF":1.084316,"CLF":0.033779,"CLP":932.076006,"CNY":7.613286,"COP":4536.76805,"CRC":737.449312,"CUC":1.181398,"CUP":31.307039,"CVE":110.092388,"CZK":25.350201,"DJF":209.958466,"DKK":7.435789,"DOP":66.992917,"DZD":160.846778,"EGP":18.562953,"ERN":17.726652,"ETB":54.527108,"EUR":1,"FJD":2.44857,"FKP":0.853682,"GBP":0.853589,"GEL":3.686423,"GGP":0.853682,"GHS":7.134514,"GIP":0.853682,"GMD":60.464395,"GNF":11552.287414,"GTQ":9.137486,"GYD":246.924798,"HKD":9.18929,"HNL":28.412977,"HRK":7.487231,"HTG":116.059348,"HUF":350.308508,"IDR":16837.221116,"ILS":3.780674,"IMP":0.853682,"INR":86.822749,"IQD":1724.729124,"IRR":49843.16987,"ISK":151.195735,"JEP":0.853682,"JMD":177.221889,"JOD":0.837658,"JPY":129.864558,"KES":129.840102,"KGS":100.187017,"KHR":4818.573325,"KMF":495.006055,"KPW":1063.258139,"KRW":1382.271218,"KWD":0.355015,"KYD":0.984444,"KZT":503.730212,"LAK":11321.755113,"LBP":1786.357975,"LKR":235.969201,"LRD":203.023648,"LSL":17.626905,"LTL":3.488361,"LVL":0.714616,"LYD":5.335535,"MAD":10.56174,"MDL":20.730397,"MGA":4628.602912,"MKD":61.518546,"MMK":2043.688782,"MNT":3368.048086,"MOP":9.462605,"MRO":421.75878,"MUR":49.971232,"MVR":18.253042,"MWK":960.25943,"MXN":23.468312,"MYR":4.886856,"MZN":75.343685,"NAD":17.6269,"NGN":486.062906,"NIO":41.478966,"NOK":10.228843,"NPR":138.777748,"NZD":1.658358,"OMR":0.45486,"PAB":1.181353,"PEN":4.848529,"PGK":4.147865,"PHP":59.028582,"PKR":198.698525,"PLN":4.541943,"PYG":8158.233964,"QAR":4.301514,"RON":4.942855,"RSD":117.420898,"RUB":86.431888,"RWF":1193.015529,"SAR":4.431035,"SBD":9.519779,"SCR":15.368848,"SDG":523.95423,"SEK":10.188197,"SGD":1.584562,"SHP":1.627262,"SLL":12197.931773,"SOS":691.118061,"SRD":25.24352,"STD":24452.547398,"SVC":10.335795,"SYP":1485.695013,"SZL":16.649376,"THB":38.636021,"TJS":13.389108,"TMT":4.146706,"TND":3.295513,"TOP":2.654645,"TRY":9.995929,"TTD":8.026129,"TWD":32.668487,"TZS":2739.074889,"UAH":31.573996,"UGX":4163.771711,"USD":1.181398,"UYU":50.460369,"UZS":12601.342623,"VEF":252618535348.0963,"VND":26886.249121,"VUV":131.001561,"WST":3.025281,"XAF":654.988272,"XAG":0.049555,"XAU":0.00066,"XCD":3.192787,"XDR":0.829174,"XOF":654.930149,"XPF":120.361229,"YER":296.354046,"ZAR":16.762486,"ZMK":10634.001327,"ZMW":19.177033,"ZWL":380.409581}}
Time taken: 335 milliseconds.
```

If you run it again within 15 seconds, you'll see a cache hit and should note that the code runs faster as it's not making the origin API call to exchangeratesapi.io:

```bash
$ ./run.sh
Looking in cache for: rates:latest
Cache hit!
{"success":true,"timestamp":1631298844,"base":"EUR","date":"2021-09-10","rates":{"AED":4.339227,"AFN":100.032052,"ALL":121.609331,"AMD":582.252339,"ANG":2.120464,"AOA":738.703229,"ARS":115.89453,"AUD":1.604516,"AWG":2.127107,"AZN":2.013066,"BAM":1.952768,"BBD":2.385172,"BDT":100.471503,"BGN":1.952977,"BHD":0.445322,"BIF":2345.722192,"BMD":1.181398,"BND":1.58196,"BOB":8.145253,"BRL":6.202461,"BSD":1.181353,"BTC":2.5840863e-5,"BTN":86.736017,"BWP":12.882547,"BYN":2.96605,"BYR":23155.395148,"BZD":2.380967,"CAD":1.495591,"CDF":2359.251658,"CHF":1.084316,"CLF":0.033779,"CLP":932.076006,"CNY":7.613286,"COP":4536.76805,"CRC":737.449312,"CUC":1.181398,"CUP":31.307039,"CVE":110.092388,"CZK":25.350201,"DJF":209.958466,"DKK":7.435789,"DOP":66.992917,"DZD":160.846778,"EGP":18.562953,"ERN":17.726652,"ETB":54.527108,"EUR":1,"FJD":2.44857,"FKP":0.853682,"GBP":0.853589,"GEL":3.686423,"GGP":0.853682,"GHS":7.134514,"GIP":0.853682,"GMD":60.464395,"GNF":11552.287414,"GTQ":9.137486,"GYD":246.924798,"HKD":9.18929,"HNL":28.412977,"HRK":7.487231,"HTG":116.059348,"HUF":350.308508,"IDR":16837.221116,"ILS":3.780674,"IMP":0.853682,"INR":86.822749,"IQD":1724.729124,"IRR":49843.16987,"ISK":151.195735,"JEP":0.853682,"JMD":177.221889,"JOD":0.837658,"JPY":129.864558,"KES":129.840102,"KGS":100.187017,"KHR":4818.573325,"KMF":495.006055,"KPW":1063.258139,"KRW":1382.271218,"KWD":0.355015,"KYD":0.984444,"KZT":503.730212,"LAK":11321.755113,"LBP":1786.357975,"LKR":235.969201,"LRD":203.023648,"LSL":17.626905,"LTL":3.488361,"LVL":0.714616,"LYD":5.335535,"MAD":10.56174,"MDL":20.730397,"MGA":4628.602912,"MKD":61.518546,"MMK":2043.688782,"MNT":3368.048086,"MOP":9.462605,"MRO":421.75878,"MUR":49.971232,"MVR":18.253042,"MWK":960.25943,"MXN":23.468312,"MYR":4.886856,"MZN":75.343685,"NAD":17.6269,"NGN":486.062906,"NIO":41.478966,"NOK":10.228843,"NPR":138.777748,"NZD":1.658358,"OMR":0.45486,"PAB":1.181353,"PEN":4.848529,"PGK":4.147865,"PHP":59.028582,"PKR":198.698525,"PLN":4.541943,"PYG":8158.233964,"QAR":4.301514,"RON":4.942855,"RSD":117.420898,"RUB":86.431888,"RWF":1193.015529,"SAR":4.431035,"SBD":9.519779,"SCR":15.368848,"SDG":523.95423,"SEK":10.188197,"SGD":1.584562,"SHP":1.627262,"SLL":12197.931773,"SOS":691.118061,"SRD":25.24352,"STD":24452.547398,"SVC":10.335795,"SYP":1485.695013,"SZL":16.649376,"THB":38.636021,"TJS":13.389108,"TMT":4.146706,"TND":3.295513,"TOP":2.654645,"TRY":9.995929,"TTD":8.026129,"TWD":32.668487,"TZS":2739.074889,"UAH":31.573996,"UGX":4163.771711,"USD":1.181398,"UYU":50.460369,"UZS":12601.342623,"VEF":252618535348.0963,"VND":26886.249121,"VUV":131.001561,"WST":3.025281,"XAF":654.988272,"XAG":0.049555,"XAU":0.00066,"XCD":3.192787,"XDR":0.829174,"XOF":654.930149,"XPF":120.361229,"YER":296.354046,"ZAR":16.762486,"ZMK":10634.001327,"ZMW":19.177033,"ZWL":380.409581}}
Time taken: 49 milliseconds.
```

Wait 15 or more seconds, and try again... Redis will have expired the cache entry and you'll see the code making a call to the origin API and caching the subsequent response again:

```bash
$ ./run.sh
Looking in cache for: rates:latest
Cache miss, fetching from origin...
Caching origin response for 15 seconds at rates:latest
{"success":true,"timestamp":1631298844,"base":"EUR","date":"2021-09-10","rates":{"AED":4.339227,"AFN":100.032052,"ALL":121.609331,"AMD":582.252339,"ANG":2.120464,"AOA":738.703229,"ARS":115.89453,"AUD":1.604516,"AWG":2.127107,"AZN":2.013066,"BAM":1.952768,"BBD":2.385172,"BDT":100.471503,"BGN":1.952977,"BHD":0.445322,"BIF":2345.722192,"BMD":1.181398,"BND":1.58196,"BOB":8.145253,"BRL":6.202461,"BSD":1.181353,"BTC":2.5840863e-5,"BTN":86.736017,"BWP":12.882547,"BYN":2.96605,"BYR":23155.395148,"BZD":2.380967,"CAD":1.495591,"CDF":2359.251658,"CHF":1.084316,"CLF":0.033779,"CLP":932.076006,"CNY":7.613286,"COP":4536.76805,"CRC":737.449312,"CUC":1.181398,"CUP":31.307039,"CVE":110.092388,"CZK":25.350201,"DJF":209.958466,"DKK":7.435789,"DOP":66.992917,"DZD":160.846778,"EGP":18.562953,"ERN":17.726652,"ETB":54.527108,"EUR":1,"FJD":2.44857,"FKP":0.853682,"GBP":0.853589,"GEL":3.686423,"GGP":0.853682,"GHS":7.134514,"GIP":0.853682,"GMD":60.464395,"GNF":11552.287414,"GTQ":9.137486,"GYD":246.924798,"HKD":9.18929,"HNL":28.412977,"HRK":7.487231,"HTG":116.059348,"HUF":350.308508,"IDR":16837.221116,"ILS":3.780674,"IMP":0.853682,"INR":86.822749,"IQD":1724.729124,"IRR":49843.16987,"ISK":151.195735,"JEP":0.853682,"JMD":177.221889,"JOD":0.837658,"JPY":129.864558,"KES":129.840102,"KGS":100.187017,"KHR":4818.573325,"KMF":495.006055,"KPW":1063.258139,"KRW":1382.271218,"KWD":0.355015,"KYD":0.984444,"KZT":503.730212,"LAK":11321.755113,"LBP":1786.357975,"LKR":235.969201,"LRD":203.023648,"LSL":17.626905,"LTL":3.488361,"LVL":0.714616,"LYD":5.335535,"MAD":10.56174,"MDL":20.730397,"MGA":4628.602912,"MKD":61.518546,"MMK":2043.688782,"MNT":3368.048086,"MOP":9.462605,"MRO":421.75878,"MUR":49.971232,"MVR":18.253042,"MWK":960.25943,"MXN":23.468312,"MYR":4.886856,"MZN":75.343685,"NAD":17.6269,"NGN":486.062906,"NIO":41.478966,"NOK":10.228843,"NPR":138.777748,"NZD":1.658358,"OMR":0.45486,"PAB":1.181353,"PEN":4.848529,"PGK":4.147865,"PHP":59.028582,"PKR":198.698525,"PLN":4.541943,"PYG":8158.233964,"QAR":4.301514,"RON":4.942855,"RSD":117.420898,"RUB":86.431888,"RWF":1193.015529,"SAR":4.431035,"SBD":9.519779,"SCR":15.368848,"SDG":523.95423,"SEK":10.188197,"SGD":1.584562,"SHP":1.627262,"SLL":12197.931773,"SOS":691.118061,"SRD":25.24352,"STD":24452.547398,"SVC":10.335795,"SYP":1485.695013,"SZL":16.649376,"THB":38.636021,"TJS":13.389108,"TMT":4.146706,"TND":3.295513,"TOP":2.654645,"TRY":9.995929,"TTD":8.026129,"TWD":32.668487,"TZS":2739.074889,"UAH":31.573996,"UGX":4163.771711,"USD":1.181398,"UYU":50.460369,"UZS":12601.342623,"VEF":252618535348.0963,"VND":26886.249121,"VUV":131.001561,"WST":3.025281,"XAF":654.988272,"XAG":0.049555,"XAU":0.00066,"XCD":3.192787,"XDR":0.829174,"XOF":654.930149,"XPF":120.361229,"YER":296.354046,"ZAR":16.762486,"ZMK":10634.001327,"ZMW":19.177033,"ZWL":380.409581}}
Time taken: 329 milliseconds.
```

You can also use `redis-cli` or [RedisInsight](https://redis.com/redis-enterprise/redis-insight/) to see the value stored in Redis.  Here's an example for when there is data in the cache:

```bash
$ redis-cli get rates:latest
"{\"success\":true,\"timestamp\":1631298844,\"base\":\"EUR\",\"date\":\"2021-09-10\",\"rates\":{\"AED\":4.339227,\"AFN\":100.032052,\"ALL\":121.609331,\"AMD\":582.252339,\"ANG\":2.120464,\"AOA\":738.703229,\"ARS\":115.89453,\"AUD\":1.604516,\"AWG\":2.127107,\"AZN\":2.013066,\"BAM\":1.952768,\"BBD\":2.385172,\"BDT\":100.471503,\"BGN\":1.952977,\"BHD\":0.445322,\"BIF\":2345.722192,\"BMD\":1.181398,\"BND\":1.58196,\"BOB\":8.145253,\"BRL\":6.202461,\"BSD\":1.181353,\"BTC\":2.5840863e-5,\"BTN\":86.736017,\"BWP\":12.882547,\"BYN\":2.96605,\"BYR\":23155.395148,\"BZD\":2.380967,\"CAD\":1.495591,\"CDF\":2359.251658,\"CHF\":1.084316,\"CLF\":0.033779,\"CLP\":932.076006,\"CNY\":7.613286,\"COP\":4536.76805,\"CRC\":737.449312,\"CUC\":1.181398,\"CUP\":31.307039,\"CVE\":110.092388,\"CZK\":25.350201,\"DJF\":209.958466,\"DKK\":7.435789,\"DOP\":66.992917,\"DZD\":160.846778,\"EGP\":18.562953,\"ERN\":17.726652,\"ETB\":54.527108,\"EUR\":1,\"FJD\":2.44857,\"FKP\":0.853682,\"GBP\":0.853589,\"GEL\":3.686423,\"GGP\":0.853682,\"GHS\":7.134514,\"GIP\":0.853682,\"GMD\":60.464395,\"GNF\":11552.287414,\"GTQ\":9.137486,\"GYD\":246.924798,\"HKD\":9.18929,\"HNL\":28.412977,\"HRK\":7.487231,\"HTG\":116.059348,\"HUF\":350.308508,\"IDR\":16837.221116,\"ILS\":3.780674,\"IMP\":0.853682,\"INR\":86.822749,\"IQD\":1724.729124,\"IRR\":49843.16987,\"ISK\":151.195735,\"JEP\":0.853682,\"JMD\":177.221889,\"JOD\":0.837658,\"JPY\":129.864558,\"KES\":129.840102,\"KGS\":100.187017,\"KHR\":4818.573325,\"KMF\":495.006055,\"KPW\":1063.258139,\"KRW\":1382.271218,\"KWD\":0.355015,\"KYD\":0.984444,\"KZT\":503.730212,\"LAK\":11321.755113,\"LBP\":1786.357975,\"LKR\":235.969201,\"LRD\":203.023648,\"LSL\":17.626905,\"LTL\":3.488361,\"LVL\":0.714616,\"LYD\":5.335535,\"MAD\":10.56174,\"MDL\":20.730397,\"MGA\":4628.602912,\"MKD\":61.518546,\"MMK\":2043.688782,\"MNT\":3368.048086,\"MOP\":9.462605,\"MRO\":421.75878,\"MUR\":49.971232,\"MVR\":18.253042,\"MWK\":960.25943,\"MXN\":23.468312,\"MYR\":4.886856,\"MZN\":75.343685,\"NAD\":17.6269,\"NGN\":486.062906,\"NIO\":41.478966,\"NOK\":10.228843,\"NPR\":138.777748,\"NZD\":1.658358,\"OMR\":0.45486,\"PAB\":1.181353,\"PEN\":4.848529,\"PGK\":4.147865,\"PHP\":59.028582,\"PKR\":198.698525,\"PLN\":4.541943,\"PYG\":8158.233964,\"QAR\":4.301514,\"RON\":4.942855,\"RSD\":117.420898,\"RUB\":86.431888,\"RWF\":1193.015529,\"SAR\":4.431035,\"SBD\":9.519779,\"SCR\":15.368848,\"SDG\":523.95423,\"SEK\":10.188197,\"SGD\":1.584562,\"SHP\":1.627262,\"SLL\":12197.931773,\"SOS\":691.118061,\"SRD\":25.24352,\"STD\":24452.547398,\"SVC\":10.335795,\"SYP\":1485.695013,\"SZL\":16.649376,\"THB\":38.636021,\"TJS\":13.389108,\"TMT\":4.146706,\"TND\":3.295513,\"TOP\":2.654645,\"TRY\":9.995929,\"TTD\":8.026129,\"TWD\":32.668487,\"TZS\":2739.074889,\"UAH\":31.573996,\"UGX\":4163.771711,\"USD\":1.181398,\"UYU\":50.460369,\"UZS\":12601.342623,\"VEF\":252618535348.0963,\"VND\":26886.249121,\"VUV\":131.001561,\"WST\":3.025281,\"XAF\":654.988272,\"XAG\":0.049555,\"XAU\":0.00066,\"XCD\":3.192787,\"XDR\":0.829174,\"XOF\":654.930149,\"XPF\":120.361229,\"YER\":296.354046,\"ZAR\":16.762486,\"ZMK\":10634.001327,\"ZMW\":19.177033,\"ZWL\":380.409581}}"
```

and here's now to see what the remaining time to live in seconds is before Redis expires the data:

```bash
$ redis-cli ttl rates:latest
(integer) 3
```

In this case, data hasn't been cached yet or has expired:

```bash
$ redis-cli get rates:latest
(nil)
```